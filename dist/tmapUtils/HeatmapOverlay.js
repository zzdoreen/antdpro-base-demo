T.HeatmapOverlay=T.Overlay.extend({initialize:function(e){this.conf=e,this.heatmap=null,this.latlngs=[],this.bounds=null},onAdd:function(e){this._map=e;var n=document.createElement("div");if(n.style.position="absolute",n.style.top=0,n.style.left=0,n.style.border=0,n.style.width=this._map.getSize().x+"px",n.style.height=this._map.getSize().y+"px",this.conf.container=n,!this.isSupportCanvas())return n;this.conf.valueField=this.conf.valueField||"count",this.conf.latField=this.conf.latField||"lat",this.conf.lngField=this.conf.lngField||"lng",this.heatmap=h337.create(this.conf),this.heatmap._renderer.setDimensions(this._map.getSize().x,this._map.getSize().y),e.getPanes().overlayPane.appendChild(n),e.on("moveend",this._reset,this),this._div=n},onRemove:function(e){e.getPanes().overlayPane.removeChild(this._div),e.off("moveend",this._reset,this)},_reset:function(){var e=this._map.getSize();this._div.style.width=e.x+"px",this._div.style.height=e.y+"px",this.heatmap._renderer.setDimensions(e.x,e.y),this.draw()},getElement:function(){return this.conf.container},draw:function(){if(!!this.isSupportCanvas()){var e=this._map.getBounds();if(!this.isadd&&e.equals(this.bounds)){this.isadd=!1;return}this.bounds=e;var n=this._map.lngLatToLayerPoint(e.getNorthEast()),l=this._map.lngLatToLayerPoint(e.getSouthWest()),c=n.y,p=l.x,D=l.y-n.y,S=n.x-l.x;this.conf.container.style.width=S+"px",this.conf.container.style.height=D+"px",this.conf.container.style[this.CSS_TRANSFORM()]="translate("+Math.round(p)+"px,"+Math.round(c)+"px)",this.latlngs.length>0&&this.heatmap.removeData();var g=this.latlngs.length;for(d={max:this.heatmap._store.getData().max,data:[]};g--;){var _=this.latlngs[g].latlng;if(!!e.contains(_)){var y=this._getContainerPoint(_);d.data.push({x:y.x,y:y.y,count:this.latlngs[g].c})}}this.heatmap.setData(d)}},CSS_TRANSFORM:function(){for(var e=document.createElement("div"),n=["transform","WebkitTransform","MozTransform","OTransform","msTransform"],l=0;l<n.length;l++){var c=n[l];if(e.style[c]!==void 0)return c}return n[0]},setDataSet:function(e){if(this.data=e,!!this.isSupportCanvas()){var n=this._map.getBounds(),l={max:e.max,data:[]},c=e.data,p=c.length;for(this.latlngs=[],this.heatmap.removeData();p--;){var D=new T.LngLat(c[p][this.conf.lngField],c[p][this.conf.latField]);if(this.latlngs.push({latlng:D,c:c[p].count}),!!n.contains(D)){var S=this._getContainerPoint(D);l.data.push({x:S.x,y:S.y,count:c[p].count})}}this.heatmap.setData(l)}},_getContainerPoint:function(e){var n=this._map.getBounds(),l=this._map.lngLatToLayerPoint(e),c=this._map.lngLatToLayerPoint(n.getSouthWest()).x,p=this._map.lngLatToLayerPoint(n.getNorthEast()).y,D=new T.Point(l.x-c,l.y-p),S=this.pixelTransform(D);return S},addDataPoint:function(e,n,l){if(!!this.isSupportCanvas()){this.data&&this.data.data&&this.data.data.push({lng:e,lat:n,count:l});var c=new T.LngLat(e,n),p=this.pixelTransform(this._map.lngLatToContainerPoint(c));this.latlngs.push({latlng:c,c:l}),this.isadd=!0,this.draw()}},pixelTransform:function(e){var n=this.heatmap._config.container.clientHeight,l=this.heatmap._config.container.clientWidth;if(l==0||n==0)return e;for(;e.x<0;)e.x+=l;for(;e.x>l;)e.x-=l;for(;e.y<0;)e.y+=n;for(;e.y>n;)e.y-=n;return e.x=e.x>>0,e.y=e.y>>0,e},toggle:function(){if(!!this.isSupportCanvas())return this.conf.visible===!0?this.conf.visible=!1:this.conf.visible=!0,this.conf.visible?this.conf.container.style.display="block":this.conf.container.style.display="none",this.conf.visible},setOptions:function(e){if(!!this.isSupportCanvas()){for(var n in e)n=="radius"&&(this.heatmap._store._cfgRadius=e[n]),n=="opacity"&&(e[n]=e[n]/100);this.heatmap.configure(e),this.data&&this.setDataSet(this.data)}},isSupportCanvas:function(){var e=document.createElement("canvas");return!!(e.getContext&&e.getContext("2d"))}}),function(e,n,l){typeof module!="undefined"&&module.exports?module.exports=l():typeof define=="function"&&define.amd?define(l):n[e]=l()}("h337",this,function(){var e={defaultRadius:40,defaultRenderer:"canvas2d",defaultGradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},defaultMaxOpacity:1,defaultMinOpacity:0,defaultBlur:.85,defaultXField:"x",defaultYField:"y",defaultValueField:"value",plugins:{}},n=function(){var _=function(r){this._coordinator={},this._data=[],this._radi=[],this._min=0,this._max=1,this._xField=r.xField||r.defaultXField,this._yField=r.yField||r.defaultYField,this._valueField=r.valueField||r.defaultValueField,r.radius&&(this._cfgRadius=r.radius)},y=e.defaultRadius;return _.prototype={_organiseData:function(o,r){var t=o[this._xField],a=o[this._yField],s=this._radi,i=this._data,u=this._max,h=this._min,v=o[this._valueField]||1,C=o.radius||this._cfgRadius||y;return i[t]||(i[t]=[],s[t]=[]),i[t][a]?i[t][a]+=v:(i[t][a]=v,s[t][a]=C),i[t][a]>u?(r?this.setDataMax(i[t][a]):this._max=i[t][a],!1):{x:t,y:a,value:v,radius:C,min:h,max:u}},_unOrganizeData:function(){var o=[],r=this._data,t=this._radi;for(var a in r)for(var s in r[a])o.push({x:a,y:s,radius:t[a][s],value:r[a][s]});return{min:this._min,max:this._max,data:o}},_onExtremaChange:function(){this._coordinator.emit("extremachange",{min:this._min,max:this._max})},addData:function(){if(arguments[0].length>0)for(var o=arguments[0],r=o.length;r--;)this.addData.call(this,o[r]);else{var t=this._organiseData(arguments[0],!0);t&&this._coordinator.emit("renderpartial",{min:this._min,max:this._max,data:[t]})}return this},setData:function(o){var r=o.data,t=r.length;this._data=[],this._radi=[];for(var a=0;a<t;a++)this._organiseData(r[a],!1);return this._max=o.max,this._min=o.min||0,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},removeData:function(){},setDataMax:function(o){return this._max=o,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setDataMin:function(o){return this._min=o,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setCoordinator:function(o){this._coordinator=o},_getInternalData:function(){return{max:this._max,min:this._min,data:this._data,radi:this._radi}},getData:function(){return this._unOrganizeData()}},_}(),l=function(){var _=function(t){var a=t.gradient||t.defaultGradient,s=document.createElement("canvas"),i=s.getContext("2d");s.width=256,s.height=1;var u=i.createLinearGradient(0,0,256,1);for(var h in a)u.addColorStop(h,a[h]);return i.fillStyle=u,i.fillRect(0,0,256,1),i.getImageData(0,0,256,1).data},y=function(t,a){var s=document.createElement("canvas"),i=s.getContext("2d"),u=t,h=t;if(s.width=s.height=t*2,a==1)i.beginPath(),i.arc(u,h,t,0,2*Math.PI,!1),i.fillStyle="rgba(0,0,0,1)",i.fill();else{var v=i.createRadialGradient(u,h,t*a,u,h,t);v.addColorStop(0,"rgba(0,0,0,1)"),v.addColorStop(1,"rgba(0,0,0,0)"),i.fillStyle=v,i.fillRect(0,0,2*t,2*t)}return s},o=function(t){for(var a=[],s=t.min,i=t.max,u=t.radi,t=t.data,h=Object.keys(t),v=h.length;v--;)for(var C=h[v],f=Object.keys(t[C]),R=f.length;R--;){var x=f[R],m=t[C][x],F=u[C][x];a.push({x:C,y:x,value:m,radius:F})}return{min:s,max:i,data:a}};function r(t){var a=t.container,s=this.shadowCanvas=document.createElement("canvas"),i=this.canvas=t.canvas||document.createElement("canvas"),u=this._renderBoundaries=[1e4,1e4,0,0],h=getComputedStyle(t.container)||{};i.className="heatmap-canvas",this._width=i.width=s.width=t.width||+h.width.replace(/px/,""),this._height=i.height=s.height=t.height||+h.height.replace(/px/,""),this.shadowCtx=s.getContext("2d"),this.ctx=i.getContext("2d"),i.style.cssText=s.style.cssText="position:absolute;left:0;top:0;",a.style.position="relative",a.appendChild(i),this._palette=_(t),this._templates={},this._setStyles(t)}return r.prototype={renderPartial:function(t){t.data.length>0&&(this._drawAlpha(t),this._colorize())},renderAll:function(t){this._clear(),t.data.length>0&&(this._drawAlpha(o(t)),this._colorize())},_updateGradient:function(t){this._palette=_(t)},updateConfig:function(t){t.gradient&&this._updateGradient(t),this._setStyles(t)},setDimensions:function(t,a){this._width=t,this._height=a,this.canvas.width=this.shadowCanvas.width=t,this.canvas.height=this.shadowCanvas.height=a},_clear:function(){this.shadowCtx.clearRect(0,0,this._width,this._height),this.ctx.clearRect(0,0,this._width,this._height)},_setStyles:function(t){this._blur=t.blur==0?0:t.blur||t.defaultBlur,t.backgroundColor&&(this.canvas.style.backgroundColor=t.backgroundColor),this._width=this.canvas.width=this.shadowCanvas.width=t.width||this._width,this._height=this.canvas.height=this.shadowCanvas.height=t.height||this._height,this._opacity=(t.opacity||0)*255,this._maxOpacity=(t.maxOpacity||t.defaultMaxOpacity)*255,this._minOpacity=(t.minOpacity||t.defaultMinOpacity)*255,this._useGradientOpacity=!!t.useGradientOpacity},_drawAlpha:function(t){for(var a=this._min=t.min,s=this._max=t.max,t=t.data||[],i=t.length,u=1-this._blur;i--;){var h=t[i],v=h.x,C=h.y,f=h.radius,R=Math.min(h.value,s),x=v-f,m=C-f,F=this.shadowCtx,b;this._templates[f]?b=this._templates[f]:this._templates[f]=b=y(f,u);var w=(R-a)/(s-a);F.globalAlpha=w<.01?.01:w,F.drawImage(b,x,m),x<this._renderBoundaries[0]&&(this._renderBoundaries[0]=x),m<this._renderBoundaries[1]&&(this._renderBoundaries[1]=m),x+2*f>this._renderBoundaries[2]&&(this._renderBoundaries[2]=x+2*f),m+2*f>this._renderBoundaries[3]&&(this._renderBoundaries[3]=m+2*f)}},_colorize:function(){var t=this._renderBoundaries[0],a=this._renderBoundaries[1],s=this._renderBoundaries[2]-t,i=this._renderBoundaries[3]-a,u=this._width,h=this._height,v=this._opacity,C=this._maxOpacity,f=this._minOpacity,R=this._useGradientOpacity;t<0&&(t=0),a<0&&(a=0),t+s>u&&(s=u-t),a+i>h&&(i=h-a);for(var x=this.shadowCtx.getImageData(t,a,s,i),m=x.data,F=m.length,b=this._palette,w=3;w<F;w+=4){var P=m[w],O=P*4;if(!!O){var B;v>0?B=v:P<C?P<f?B=f:B=P:B=C,m[w-3]=b[O],m[w-2]=b[O+1],m[w-1]=b[O+2],m[w]=R?b[O+3]:B}}x.data=m,this.ctx.putImageData(x,t,a),this._renderBoundaries=[1e3,1e3,0,0]},getValueAt:function(t){var a,s=this.shadowCtx,i=s.getImageData(t.x,t.y,1,1),u=i.data[3],h=this._max,v=this._min;return a=Math.abs(h-v)*(u/255)>>0,a},getDataURL:function(){return this.canvas.toDataURL()}},r}(),c=function(){var _=!1;return e.defaultRenderer==="canvas2d"&&(_=l),_}(),p={merge:function(){for(var g={},_=arguments.length,y=0;y<_;y++){var o=arguments[y];for(var r in o)g[r]=o[r]}return g}},D=function(){var _=function(){function t(){this.cStore={}}return t.prototype={on:function(a,s,i){var u=this.cStore;u[a]||(u[a]=[]),u[a].push(function(h){return s.call(i,h)})},emit:function(a,s){var i=this.cStore;if(i[a])for(var u=i[a].length,h=0;h<u;h++){var v=i[a][h];v(s)}}},t}(),y=function(r){var t=r._renderer,a=r._coordinator,s=r._store;a.on("renderpartial",t.renderPartial,t),a.on("renderall",t.renderAll,t),a.on("extremachange",function(i){r._config.onExtremaChange&&r._config.onExtremaChange({min:i.min,max:i.max,gradient:r._config.gradient||r._config.defaultGradient})}),s.setCoordinator(a)};function o(){var r=this._config=p.merge(e,arguments[0]||{});if(this._coordinator=new _,r.plugin){var t=r.plugin;if(e.plugins[t]){var a=e.plugins[t];this._renderer=new a.renderer(r),this._store=new a.store(r)}else throw new Error("Plugin '"+t+"' not found. Maybe it was not registered.")}else this._renderer=new c(r),this._store=new n(r);y(this)}return o.prototype={addData:function(){return this._store.addData.apply(this._store,arguments),this},removeData:function(){return this._store.removeData&&this._store.removeData.apply(this._store,arguments),this},setData:function(){return this._store.setData.apply(this._store,arguments),this},setDataMax:function(){return this._store.setDataMax.apply(this._store,arguments),this},setDataMin:function(){return this._store.setDataMin.apply(this._store,arguments),this},configure:function(r){return this._config=p.merge(this._config,r),this._renderer.updateConfig(this._config),this._coordinator.emit("renderall",this._store._getInternalData()),this},repaint:function(){return this._coordinator.emit("renderall",this._store._getInternalData()),this},getData:function(){return this._store.getData()},getDataURL:function(){return this._renderer.getDataURL()},getValueAt:function(r){return this._store.getValueAt?this._store.getValueAt(r):this._renderer.getValueAt?this._renderer.getValueAt(r):null}},o}(),S={create:function(g){return new D(g)},register:function(g,_){e.plugins[g]=_}};return S});
